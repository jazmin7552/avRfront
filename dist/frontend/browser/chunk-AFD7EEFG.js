import{a as U}from"./chunk-XQHYLHBR.js";import{d as c,g as s,j as i,k as a,n as g,q as d,wa as p,xa as m}from"./chunk-BCLJKQU2.js";var h=class l{constructor(e){this.http=e;let o=localStorage.getItem("usuario");if(o)try{this.currentUserSubject.next(JSON.parse(o))}catch(r){console.error("Error al parsear usuario:",r),localStorage.removeItem("usuario")}}apiUrl=U.apiUrl;currentUserSubject=new c(null);currentUser$=this.currentUserSubject.asObservable();login(e){return console.log("\u{1F504} Intentando login en:",`${this.apiUrl}/auth/login`),console.log("\u{1F4E4} Credenciales:",{email:e.email,password:"***"}),this.http.post(`${this.apiUrl}/auth/login`,e).pipe(a(o=>{console.log("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.log("\u2705 RESPUESTA COMPLETA DEL BACKEND:"),console.log(JSON.stringify(o,null,2)),console.log("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550");let r=o.idUsuario;console.log("\u{1F50D} ID desde response.idUsuario:",r),!r&&o.token&&(console.log("\u26A0\uFE0F No viene idUsuario en el response, intentando extraer del token..."),r=this.extraerIdDelToken(o.token)),r||(console.warn("\u26A0\uFE0F No se pudo obtener ID num\xE9rico. Usando email como fallback."),r=o.email),console.log("\u2705 ID FINAL EXTRA\xCDDO:",r);let t={token:o.token,type:o.type||"Bearer",email:o.email,nombre:o.nombre,rol:o.rol,idUsuario:r};console.log("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.log("\u{1F4E6} USUARIO COMPLETO A GUARDAR:"),console.log(JSON.stringify(t,null,2)),console.log("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),localStorage.setItem("token",o.token),localStorage.setItem("usuario",JSON.stringify(t)),this.currentUserSubject.next(t),console.log("\u{1F50D} VERIFICACI\xD3N FINAL:"),console.log("  \u2713 Token guardado:",!!localStorage.getItem("token")),console.log("  \u2713 Usuario guardado:",!!localStorage.getItem("usuario")),console.log("  \u2713 ID Usuario:",this.getIdUsuario()),console.log("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550")}),i(this.handleError))}extraerIdDelToken(e){try{console.log("\u{1F513} Intentando decodificar token...");let o=e.split(".");if(o.length!==3)return console.error("\u274C Token JWT inv\xE1lido (no tiene 3 partes)"),null;let r=o[1],t=atob(r),n=JSON.parse(t);console.log("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.log("\u{1F513} PAYLOAD DEL TOKEN DECODIFICADO:"),console.log(JSON.stringify(n,null,2)),console.log("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550");let u=n.id||n.id_usuario||n.idUsuario||n.userId||n.user_id||n.sub||null;return console.log("\u{1F194} ID extra\xEDdo del token:",u),u?String(u):null}catch(o){return console.error("\u274C Error al decodificar token:",o),null}}getIdUsuario(){let e=this.getUsuario();if(!e)return console.error("\u274C No hay usuario en localStorage"),null;let o=e.idUsuario;return o||(console.error("\u274C El usuario NO tiene idUsuario:",e),console.error("\u{1F527} Intenta cerrar sesi\xF3n y volver a iniciar sesi\xF3n")),o}logout(){console.log("\u{1F6AA} Cerrando sesi\xF3n..."),localStorage.removeItem("token"),localStorage.removeItem("usuario"),this.currentUserSubject.next(null)}getToken(){return localStorage.getItem("token")}getUsuario(){let e=localStorage.getItem("usuario");if(!e)return null;try{let o=JSON.parse(e);if(!o.idUsuario&&o.token){console.warn("\u26A0\uFE0F Usuario sin idUsuario, intentando extraer del token...");let r=this.extraerIdDelToken(o.token);r&&(o.idUsuario=r,localStorage.setItem("usuario",JSON.stringify(o)),console.log("\u2705 ID actualizado en localStorage:",r))}return o}catch(o){return console.error("\u274C Error al parsear usuario:",o),null}}isAuthenticated(){let e=this.getToken(),o=this.getUsuario(),r=!!o?.idUsuario,t=!!e&&!!o&&r;return t||console.warn("\u26A0\uFE0F Usuario NO autenticado:",{tieneToken:!!e,tieneUsuario:!!o,tieneIdUsuario:r}),t}isAdmin(){return this.getUsuario()?.rol==="ADMIN"}getUsuariosPorRol(e){return console.log(`\u{1F50D} Cargando usuarios con rol: ${e}`),this.http.get(`${this.apiUrl}/usuarios/rol/${e}`).pipe(a(o=>{console.log(`\u2705 Usuarios con rol ${e}:`,o)}),i(o=>(console.error(`\u274C Error al cargar usuarios con rol ${e}:`,o),s(()=>o))))}getAllUsuarios(){console.log("\u{1F50D} Cargando todos los usuarios");let e=this.getToken(),o=new p;return e&&(o=o.set("Authorization",`Bearer ${e}`)),this.http.get(`${this.apiUrl}/usuarios`,{headers:o}).pipe(a(r=>{console.log("\u2705 Total usuarios cargados:",r.length)}),i(r=>(console.error("\u274C Error al cargar usuarios:",r),s(()=>r))))}handleError(e){console.log("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550"),console.error("\u274C ERROR EN LOGIN:"),console.error("Status:",e.status),console.error("Error completo:",e),console.log("\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550\u2550");let o="Ha ocurrido un error";return e.status===0?o=`\u274C No se puede conectar con el servidor.

Posibles causas:
\u2022 El backend no est\xE1 corriendo
\u2022 Problema de CORS
\u2022 URL incorrecta: `+this.apiUrl:e.status===401?o="Credenciales incorrectas":e.status===404?o="Endpoint no encontrado: "+this.apiUrl+"/auth/login":e.error?.message&&(o=e.error.message),s(()=>({status:e.status,message:o}))}static \u0275fac=function(o){return new(o||l)(d(m))};static \u0275prov=g({token:l,factory:l.\u0275fac,providedIn:"root"})};export{h as a};
